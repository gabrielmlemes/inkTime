name: CI – Code Quality

on:
  push:
    branches:
      - master

jobs:
  quality:
    name: Lint, Build & SonarCloud
    runs-on: ubuntu-latest

    steps:
      # 1. Faz o checkout do código do repositório
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Configura Node.js igual ao que é usado no projeto (v22)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm' # ← Ativa cache automático das dependências

      # 3. Instala dependências (se já estiver no cache, será muito mais rápido)
      - name: Install dependencies
        run: npm install

      # 4. Roda ESLint para garantir que o código segue o padrão definido
      - name: Run ESLint
        run: npx eslint . --max-warnings=0
        continue-on-error: true

      # 5. Executa o build do Next.js para validar se o projeto compila corretamente
      - name: Build Next.js
        run: npm run build

      # 6. Roda os testes e gera o relatório de cobertura
      - name: Run Tests & Generate Coverage
        run: npm test

      # 7. Roda o SonarCloud apenas como scanner de qualidade, sem bloquear o CI
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true # CI continua mesmo se o Sonar acusar baixa cobertura
